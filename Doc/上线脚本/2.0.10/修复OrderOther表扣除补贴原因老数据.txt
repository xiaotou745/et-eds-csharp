use superman
go


WITH  o as (
SELECT  ord.OrderId,ISNULL(GrabTime, '') AS GrabTime,ISNULL(ab.ActualDoneDate, '') AS ActualDoneDate,
                                    CASE ISNULL(ord.GrabLatitude, 0)
                                        WHEN 0 THEN -1
                                        ELSE CASE ISNULL(ord.CompleteLatitude, 0)
                                                WHEN 0 THEN -1
                                                ELSE ord.GrabToCompleteDistance
                                            END
                                    END AS GrabToCompleteDistance
                            FROM  [order] (NOLOCK) ab  
                                    JOIN OrderOther (NOLOCK) ord ON ord.OrderId = ab.Id
                                    JOIN business (NOLOCK) c ON c.id = ab.businessId WHERE ord.IsNotRealOrder=1)
UPDATE OrderOther set DeductCommissionReason=temp.reason  from  (select o.OrderId, case WHEN o.GrabToCompleteDistance > -1 and o.GrabToCompleteDistance<=20 THEN '接单-完成位置重合' 

	 WHEN dateadd(MINUTE ,5,o.GrabTime) < o.ActualDoneDate and o.ActualDoneDate < dateadd(MINUTE ,120,o.GrabTime) THEN '完成时间不在5-120分钟内'

	
 ELSE '完成订单量超过50个' END AS reason from o) temp,OrderOther oo where oo.OrderId=temp.OrderId;