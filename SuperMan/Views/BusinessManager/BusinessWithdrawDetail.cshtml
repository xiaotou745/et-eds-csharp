@model Ets.Model.DataModel.Order.OrderListModel
@{
    Layout = "~/Views/Shared/_LayoutNew.cshtml";
}
<link href="~/Content/themes/base/jquery-ui.css" rel="stylesheet" />
<script src="~/Scripts/jquery-1.8.2.js"></script>
<script src="~/Scripts/jquery-ui-1.8.20.js"></script>
<script src="~/Scripts/jquery.ui.datepicker-zh-CN.js"></script>
<div style="width:1000px">
    @{
        var strstatus = "";
        if (Model.Status == Ets.Model.Common.ConstValues.ORDER_FINISH)
        {
            strstatus = "已完成";
        }
        else if (Model.Status == Ets.Model.Common.ConstValues.ORDER_NEW)
        {
            strstatus = "未接单";
        }
        else if (Model.Status == Ets.Model.Common.ConstValues.ORDER_ACCEPT)
        {
            strstatus = "已接单";
        }
        else if (Model.Status == Ets.Model.Common.ConstValues.ORDER_CANCEL)
        {
            strstatus = "已取消";
        }
        var subsidy = "";
        if (Model.Status == 1 || Model.Status == 2 || Model.Status == 3)
        {
            subsidy = "订单佣金:" + Model.OrderCommission + "," + "外送费:" + Model.DistribSubsidy + "," + "网站补贴:" + Model.WebsiteSubsidy;
        }
        var payStatus = "";
        if (Model.IsPay.Value)
        {
            payStatus = "顾客已付款";
        }
        else
        {
            payStatus = "顾客未付款";
        }
    }
    <h2 class="crumbs">
        您所在位置：财务管理 > 商户提款管理 > 商户提款详情
    </h2>
    <table class="tbstyle222" border="0" style="font-size:16px;font-weight:bold;line-height:300%;width:1000px ">
        <tr class="trclass">
            <td>本次提款：@Model.OrderNo</td>
            <td>可提款金额：@Model.PubDate</td>
            <td>状态：</td>
            <td>
                <input type="button" value="审核通过" class="searchBtn" id="btnCancel" />
                <input type="button" value="拒绝" class="searchBtn" id="btnCancel" />
            </td>
        </tr>
        <tr class="trclass">
            <td>商户名称：@Model.BusinessName</td>
            <td>电话：@Model.BusinessPhoneNo</td>
            <td></td>
            <td></td>
        </tr>
        <tr class="trclass">
            <td>当前余额:@Model.RecevicePhoneNo</td>
            <td>累计提款：@Model.ReceviceAddress</td>
            <td>累计充值:@Model.RecevicePhoneNo</td>
            <td></td>
        </tr>
        <tr class="trclass">
            <td>所属银行:@Model.RecevicePhoneNo</td>
            <td>持卡人姓名：@Model.ReceviceAddress</td>
            <td>银行卡号:@Model.RecevicePhoneNo</td>
            <td>身份证号:</td>
        </tr>
        <tr class="trclass">
            <td>拒绝原因:@Model.RecevicePhoneNo</td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
    </table>

    <input type="hidden" value="@Model.OrderNo" id="OrderNo" />
    <input type="hidden" value="@Model.Id" id="OrderId" />
    @if (Model.HadUploadCount > 0)
    {
        var puth = SuperManCore.CustomerIconUploader.Instance.RelativePath;
        var PicHost = SuperManCore.CustomerIconUploader.Instance.PicHost;
        var picAdressArray = Model.ReceiptPic.Split(new char[] { '|' }, StringSplitOptions.RemoveEmptyEntries);
        <h4 style="color:black;font-weight:100">
            <label>
                骑士上传小票：@Model.HadUploadCount/@Model.NeedUploadCount @if (Model.HadUploadCount == Model.NeedUploadCount)
                { <label>(已完成)</label>}
            </label>
        </h4>
        <div style="width:1000px;float:left">
            @foreach (var temp in picAdressArray)
            {
                int fileLastDot = temp.LastIndexOf('.');
                string fileHandHouZhui = temp.Substring(fileLastDot, temp.Length - fileLastDot);
                string bigFileName = PicHost + puth + temp.Substring(0, fileLastDot) + "_0_0" + fileHandHouZhui;
                <div style="float:left;padding-right:3px">
                    <img src="@( PicHost + puth + temp.ToString())" style=" width:180px; height:140px" />
                    <a id="showBigBusiImage" href="@bigFileName" target="_blank">查看大图</a>
                </div>

            }
        </div>
    }
    <div style="float:left;width:1000px;padding-top:30px">
        <table border="0" cellspacing="0" cellpadding="0" class="tbstyle" width="1000">
            <thead>
                <tr class="tdbg">
                    <th>提款时间</th>
                    <th>交易流水号</th>
                    <th>所属银行</th>
                    <th>账户名称</th>
                    <th>卡号</th>
                    <th>提款金额</th>
                    <th>余额</th>
                    <th>状态</th>
                    <th>操作时间</th>
                    <th>操作人</th>
                </tr>
            </thead>
            <tbody>
                @{
                    var orderOptionLogList = ViewBag.orderOptionLog as List<Ets.Model.DataModel.Order.OrderSubsidiesLog>;
                    var i = 0;
                    var orderstatus = "";
                    var strplatform = "";
                    foreach (var item in orderOptionLogList)
                    {
                        if (item.OrderStatus == Ets.Model.Common.ConstValues.ORDER_FINISH)
                        {
                            orderstatus = "已完成";
                        }
                        else if (item.OrderStatus == Ets.Model.Common.ConstValues.ORDER_NEW)
                        {
                            orderstatus = "未接单";
                        }
                        else if (item.OrderStatus == Ets.Model.Common.ConstValues.ORDER_ACCEPT)
                        {
                            orderstatus = "已接单";
                        }
                        else if (item.OrderStatus == Ets.Model.Common.ConstValues.ORDER_CANCEL)
                        {
                            orderstatus = "已取消";
                        }

                        if (item.Platform == 0)
                        {
                            strplatform = "商家端";
                        }
                        else if (item.Platform == 1)
                        {
                            strplatform = "配送端";
                        }
                        else if (item.Platform == 2)
                        {
                            strplatform = "服务平台";
                        }
                        else if (item.Platform == 3)
                        {
                            strplatform = "管理后台";
                        }
                        i++;
                        <tr id="@item.Id">
                            <td>@orderstatus</td>
                            <td>@item.OptName</td>
                            <td>@item.InsertTime</td>
                            <td>@item.Remark</td>
                            <td>@strplatform</td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
    @if (Model.Status != 3)
    {
        <div class="SearchMd" style="float:left">
            <table border="0" cellspacing="0" cellpadding="0">
                <tr>
                    <td>
                        @if (SuperMan.App_Start.UserContext.Current.HasAuthority(39))
                        {
                            <input type="button" value="取消订单" class="searchBtn" id="btnCancel" />
                        }
                    </td>
                </tr>
            </table>
        </div>
    }
    <div class="selectSupplierDish">
        <div class="add-openbox add-form" id="OrderOptionShow" style="width:500px">
            <fieldset>
                <div class="control-group">
                    <label class="control-label" for="input01">操作描述</label>
                    <div class="controls">
                        <textarea cols="45" rows="5" id="orderOptionLog"></textarea>
                        <p class="help-block"></p>
                    </div>
                </div>
            </fieldset>
            <p class="btnbox">
                <input value="确认" type="button" id="btnSave" class="yesBtn" />
                <input value="关闭" type="button" class="J_closebox qxBtn" />
            </p>
        </div>
    </div>
</div>
<script>
    var adminjs = new adminglass(); //实例化后台类
    $("#btnCancel").click(function () {
        adminjs.openwinbox('#OrderOptionShow');

    });
    $('.J_closebox').click(function () {
        adminjs.closewinbox('.add-openbox');
        return false;
    });
    $('#btnSave').bind('click', function () {
        var orderNo = $('#OrderNo').val();
        var orderId = $('#OrderId').val();
        var orderOptionLog = $('#orderOptionLog').val();
        if ($("#orderOptionLog").val().trim() == "") {
            alert("操作描述不能为空！");
            return false;
        }
        if (confirm("确定要取消该订单吗？")) {
            var paramaters = { "OrderNo": orderNo, "OrderOptionLog": orderOptionLog };
            var url = "/Order/CancelOrder";
            $.ajax({
                type: 'POST',
                url: url,
                data: paramaters,
                success: function (result) {
                    if (result.IsSuccess) {
                        alert("订单取消成功!");
                        adminjs.closewinbox('.add-openbox');
                        window.location.href = "/Order/OrderDetail?orderNo=" + orderNo + "&orderId=" + orderId;
                    } else {
                        alert(result.Message);
                    }
                }
            });
        }
        return true;
    });
</script>







