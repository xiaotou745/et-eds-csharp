@using ETS.Data.PageData
@using Ets.Model.DataModel.Finance
@using ETS.Util;
@using ETS.Enums;
<table border="0" cellspacing="0" cellpadding="0" class="tbstyle" width="900">
    <thead>
        <tr class="tdbg">
        <th>交易类型</th>
        <th>任务单号/交易流水号</th>
        <th>收支金额</th>
        <th>支出方</th>
        <th>余额</th>
        <th>状态</th>
        <th>时间</th>
        <th>操作人</th>
        <th>备注</th>
    </thead>
    <tbody>
        @{
            //var businessBalanceRecordList = ViewBag.businessBalanceRecord as List<Ets.Model.DataModel.Finance.BusinessBalanceRecord>;
            var businessBalanceRecord = ViewBag.businessBalanceRecord as PageInfo<BusinessBalanceRecord>;
            if (businessBalanceRecord != null && businessBalanceRecord.Records.Count > 0)
            {
                var i = 0;
                var recordTypeDes = "";
                foreach (var item in businessBalanceRecord.Records)
                {
                    recordTypeDes = ETS.Extension.EnumExtenstion.GetEnumItem(((ETS.Enums.BusinessBalanceRecordRecordType) item.RecordType).GetType(), (ETS.Enums.BusinessBalanceRecordRecordType) item.RecordType).Text;
                    i++;
                    <tr id="@item.Id">
                        <td>@recordTypeDes</td>
                        <td>
                            @if (item.RecordType == (int)BusinessBalanceRecordRecordType.Recharge)
                            {
                                <a href="javascript:funRechargeDetail('@item.RelationNo')">@item.RelationNo</a>
                            }
                            else if (item.RecordType == (int)BusinessBalanceRecordRecordType.WithdrawApply ||
                                item.RecordType == (int)BusinessBalanceRecordRecordType.WithdrawRefuse ||
                                item.RecordType == (int)BusinessBalanceRecordRecordType.PayFailure)
                            {
                                <a href="javascript:funLookDetail(@item.WithwardId)">@item.RelationNo</a>
                            }
                            else
                            {
                                <a href="/Order/OrderDetail?OrderNo=@item.RelationNo&OrderId=@item.WithwardId ">@item.RelationNo</a>
                            }
                        </td>
                        <td> ￥
                            @if (item.GroupId > 0)
                            {
                                @ParseHelper.ToSplitByPercentile(false, item.GroupAmount);
                            }
                            else
                            {
                                @ParseHelper.ToSplitByPercentile(false, item.Amount);
                            }                        
                        </td>
                        @*<td>@((item.GroupAmount==0||(item.GroupAmount==0&&item.Amount==0))?"门店支出":"集团支出")</td>*@
                        <td>           
                            @{
                                var disName = "";
                                if (item.GroupId > 0)
                                {
                                    disName = "集团支出";
                                }
                                else
                                {
                                    disName = "门店支出";                         
                                }
                            }
                            @disName                        
                            
                        </td>
                        <td>￥@ParseHelper.ToSplitByPercentile(false,item.Balance)</td>
                        <td>@(item.Status == ETS.Enums.BusinessBalanceRecordStatus.Success.GetHashCode() ? "交易成功" : "交易中")</td>
                        <td>@item.OperateTime</td>
                        <td>@item.Operator</td>
                        <td>@item.Remark</td>
                    </tr>
                }
            }
        }
    </tbody>
</table>
@{
    if (businessBalanceRecord != null)
    {
        ViewBag.ActionName = "PostBusinessBalanceRecord";
        @Html.Partial("~/views/shared/PagerControl.cshtml", businessBalanceRecord)
    }
}
@*查看申请单详情*@
<div class="selectSupplierDish">
    <div class="add-openbox add-form" id="WithdrawDetailShow" style="width:480px">
        <fieldset>
            <div style="font-size:18px;"><center><b>门店提款详情</b></center></div>
        </fieldset>
        <fieldset style="border-top:hidden">
            <table border="0" cellspacing="0" cellpadding="0" style="font-size:16px;width:450px">
                <tr>
                    <td><span class="">提现日期: <label id="labWithdrawTime"></label></span></td>
                </tr>
                <tr>
                    <td><span class="">提现状态: <label id="labWithdrawStatus"></label></span></td>
                </tr>
                <tr>
                    <td><span class="">交易流水号: <label id="labWithdrawNo"></label></span> </td>
                </tr>
                <tr>
                    <td><span class="">提现金额: <label id="labAmount"></label></span></td>
                </tr>
                <tr>
                    <td><span class="">提款商铺: <label id="labBusinessName"></label></span></td>
                </tr>
                <tr>
                    <td><span class="">商铺电话: <label id="labBusinessPhoneNo"></label></span></td>
                </tr>
                <tr>
                    <td><span class="">开户银行: <label id="labBusinessOpenBank"></label></span></td>
                </tr>
                <tr>
                    <td><span class="">开户支行: <label id="labBusinessOpenSubBank"></label></span></td>
                </tr>
                <tr>
                    <td><span class="">账户名: <label id="labTrueName"></label></span></td>
                </tr>
                <tr>
                    <td><span class="">银行卡号: <label id="labAccountNo"></label></span></td>
                </tr>
            </table>
        </fieldset>
        <p class="btnbox">
            <input value="关闭" type="button" class="J_closebox qxBtn" />
        </p>
    </div>
    <div class="add-openbox add-form" id="RechargeDetailShow" style="width:480px">
        <fieldset>
            <div style="font-size:18px;"><center><b>门店充值详情</b></center></div>
        </fieldset>
        <fieldset style="border-top:hidden">
            <table border="0" cellspacing="0" cellpadding="0" style="font-size:16px;width:450px">
                <tr>
                    <td><span class="">门店: <label id="labRechargeBussinessName"></label></span></td>
                </tr>
                <tr>
                    <td><span class="">充值日期: <label id="labRechargeTime"></label></span></td>
                </tr>
                <tr>
                    <td><span class="">充值金额: <label id="labRechargeAmount"></label></span></td>
                </tr>
                <tr>
                    <td><span class="">充值后余额: <label id="labRechargeBalance"></label></span> </td>
                </tr>
                <tr>
                    <td><span class="">交易流水号: <label id="labRechargeWithwardNO"></label></span></td>
                </tr>
                <tr>
                    <td><span class="">支付方式: <label id="labRechargePayType"></label></span></td>
                </tr>
                <tr>
                    <td><span class="">交易状态: <label id="labRechargeStatus"></label></span></td>
                </tr>
            </table>
        </fieldset>
        <p class="btnbox">
            <input value="关闭" type="button" class="J_closebox qxBtn" />
        </p>
    </div>
</div>
<script type="text/javascript">
    var adminjs = new adminglass(); //实例化后台类
    //查看提款单详情弹框
    function funLookDetail(withwardId) {
        funGetBusinessWithdrawForm(withwardId);
        adminjs.openwinbox('#WithdrawDetailShow');
    }
    //查看提款单详情
    function funGetBusinessWithdrawForm(withwardId) {

        var paramaters = { "withwardId": withwardId };
        var url = "/BusinessWithdraw/GetBusinessWithdrawForm";
        $.ajax({
            type: 'POST',
            url: url,
            data: paramaters,
            success: function (result) {
                if (result != null) {
                    var jsonstr = $.parseJSON(result);
                    var withdrawTime = jsonstr.WithdrawTime.replace("T", " ");
                    var strstatus = "";
                    if (jsonstr.Status == 1) {
                        strstatus = "待审核";
                    }
                    else if (jsonstr.Status == 2) {
                        strstatus = "审核通过";
                    }
                    else if (jsonstr.Status == 3) {
                        strstatus = "打款完成";
                    }
                    else if (jsonstr.Status == -1) {
                        strstatus = "审核拒绝";
                    }
                    else if (jsonstr.Status == -2) {
                        strstatus = "打款失败";
                    }
                    $('#labWithdrawTime').text(withdrawTime);
                    $('#labWithdrawStatus').text(strstatus);
                    $('#labWithdrawNo').text(jsonstr.WithwardNo);
                    $('#labAmount').text('￥'+jsonstr.Amount);
                    $('#labBusinessName').text(jsonstr.BusinessName);
                    $('#labBusinessPhoneNo').text(jsonstr.BusinessPhoneNo);
                    $('#labBusinessOpenBank').text(jsonstr.OpenBank);
                    $('#labBusinessOpenSubBank').text(jsonstr.OpenSubBank);
                    $('#labTrueName').text(jsonstr.TrueName);
                    $('#labAccountNo').text(jsonstr.AccountNo);
                }
            }
        });
    }

    //查看充值详情
    function funRechargeDetail(relationNo) {
        var paramaters = { "orderNo": relationNo };
        var url = "/BusinessManager/GetBusinessRechargeDetailByNo";
        $.ajax({
            type: 'POST',
            url: url,
            data: paramaters,
            success: function (result) {
                if (result != null) {
                    var jsonstr = $.parseJSON(result);
                    var payTime = jsonstr.PayTime.replace("T", " ");
                    var strPayType = "";
                    if (jsonstr.PayType==1) {
                        strPayType = "支付宝";
                    } else if (jsonstr.PayType == 2) {
                        strPayType = "微信";
                    }
                    var strStatus = "";
                    if (jsonstr.PayStatus == 0) {
                        strStatus = "待支付";
                    }
                    else if (jsonstr.PayStatus == 1) {
                        strStatus = "已支付";
                    }
                   
                    $('#labRechargeBussinessName').text(jsonstr.Name);
                    $('#labRechargeTime').text(payTime);
                    $('#labRechargeAmount').text('￥' + jsonstr.Amount);
                    $('#labRechargeBalance').text('￥' + jsonstr.Balance);
                    $('#labRechargeWithwardNO').text(jsonstr.OrderNo);
                    $('#labRechargePayType').text(strPayType);
                    $('#labRechargeStatus').text(strStatus);
                    adminjs.openwinbox('#RechargeDetailShow');
                }
            }
        });
    }
    //关闭弹层
    $('.J_closebox').click(function () {
        adminjs.closewinbox('.add-openbox');
        return false;
    });
</script>

